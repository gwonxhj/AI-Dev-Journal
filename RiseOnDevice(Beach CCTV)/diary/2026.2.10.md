# RKNN Web Streaming & Hybrid INT8 Pipeline

1. Hybrid INT8 변환 파이프라인 안정화
   - 오늘의 가장 큰 이슈는 YOLOv8 Large 모델 Hybrid INT8 변환 과정에서 반복적으로 발생하던
     Invalid operands name '627' 오류였다.
   - Hybrid quantization step2 단계에서 custom_quantize_layers에 존재하지 않는
     operand('627')가 포함되면 변환이 즉시 실패함.
   - 단순히 cfg를 한 번 수정하는 방식으로는, 모델 구조/버전에 따라 다른 숫자 operand가 다시
     튀어나오는 문제가 있었음.
   - 시도
     * 수동으로 cfg에서 '627' 삭제 -> 다음 실행에서 또 다른 숫자 key 에러 발생
     * grep, awk로 cfg 내부 검색 -> 숫자 operand가 quantize_parameters에만 존재함을 확인
     * preset key 수를 줄이거나 늘리는 방식 -> 근본 해결 안 됨
   - 해결 방법
     * Step1 결과 cfg를 기준으로 실제 존재하는 operand만 추출
     * quantize_parameters 블록을 파싱해 유효한 operand 집합을 먼저 수집
     * Perset B키 + numeric tail 확장을 적용하되, 존재하는 키만 custom_quantize_layers에 삽입
     * YAML 파서 사용 금지, 텍스트 레벨에서만 cfg patch
     * 결과적으로 재시도 로직 없이 step2 한 번에 성공
   - 결과
     * YOLOv8 Large 모델 Hybrid INT8 변환 안정화
     * cfg 자동 패치 구조 확립
     * 변환 결과 rknn 정상 생성
    
2. FP16 / Hybrid INT8 공용 웹 스트리밍 서버 구조 완성
   - C++ 기반 RKNN 추론 서버 + 웹 UI 구조를 정리하고 안정화함.
   - 서버 구조
     * Thread 분리
       * Decode thread: OpenCV VideoCapture(FPS 동기화)
       * Inference thread: RKNN 추론 + overlay
       * HTTP thread: MJPEG 스트리밍 및 API 처리
     * 최신 프레임 / 최신 JPEG만 공유하는 Queue=1 구조
     * MJPEG / stream.mjpg 단일 클라이언트 제한
   - 구현한 API
     * /api/status: 현재 backend, model size, conf, nms, jpeg quality, infer time 상태 조회
     * /api/set: backend / size / rgb / conf / nms / video / jpeg quality 동적 변경
     * /api/videos: 영상 목록 조회
    <img width="887" height="564" alt="스크린샷 2026-02-10 17 25 38" src="https://github.com/user-attachments/assets/44fbf643-38cc-4af3-96fc-aaf39cdf4249" />

3. INT8 성능 문제 및 프레임 드랍 대응
   - Hybrid INT8 사용 시 FP16대비 추론은 빠르지만 JPEG 인코딩 + MJPEG 송출에서 버벅임 발생
   - 해결
     * Inference loop에 프레임 스킵 로직 도입
       * stream_skip = N -> N 프레임당 1번만 JPEG 인코딩
     * skip = 1일 때는 UI에 표시하지 않도록 처리
     * JPEG resize 대상 명확화 [ imencode(frame) -> imencode(view) ]

4. JPEG Quality 조절 시 영상 깨짐 문제 해결
   - JPEG Quality를 기본 75 -> 60으로 낮췄을 때 화면이 완전히 깨지거나 ? 박스만 보이는 현상 발생
   - 원인
     * resize된 view가 아닌 원본 frame을 imencode에 전달
     * 결과적으로 메모리 레이아웃 불일치
   - 해결
     * resize 결과를 항상 view로 통일
     * imencode(".jpg", view, ...)로 수정

5. 웹 UI(index.html/app.js/style.css) 구조 정리
   - UI 개선하려고 시도하다 생긴 문제
     * index.html에서 </html> 뒤에 추가 HTML이 붙어있어 DOM이 깨짐
     * 동일한 .viewer, .panel, .row CSS가 두 세트 존재
     * JS에서 getElementByID 오타 -> 이벤트 로직 일부 비정상
     * await jget(...) 빈 호출로 apply 로직 중단
   - 해결
     * HTML 구조를 wrap/grid 기반으로 단일화
     * CSS 중복 제거(한 UI 세트만 유지)
     * UI 상태 동기화 정책 확립
       * 서버 polling 중에도 사용자가 조작 중이면 덮어쓰지 않음(dirty 플래그)
       * Apply 성공 시에만 서버 값으로 재동기화
     * video/backend/model 변경 시에만 MJPEG 스트림 재연결
   - 결과
     * Apply 버튼 정상 동작
     * conf/nms/jpeg quality 슬라이더 값 정상 표시
     * video 선택 정상 작동
     * 스트림 끊김/깨짐 현상 대폭 감소
    
6. 현재 상태 요약(완료)
   - Hybrid INT8(YOLOv8l 포함) 안정 변환
   - FP16/INT8 공용 RKNN 서버 구축
   - 실시간 MJPEG 웹 스트리밍
   - 웹 UI에서 실시간 파라미터 적용
   - INT8 성능 이슈 완화(프레임 스킵)
