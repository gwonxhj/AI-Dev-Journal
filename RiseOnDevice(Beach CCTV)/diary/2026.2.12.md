# Development Log

< 오늘의 목표 >
- IOU 기반 Tracking 안정화
- 선택 객체 하이라이트 기능 개선
- Tracks/Detections UI 구조 분리
- FPS 실시간 표시
- MJPEG 스트림 안정화
- 부팅 자동 실행 구성 및 디버깅

1. IOU 기반 Tracking 개선
   - 기존 문제
     * 동일 객체가 재검출될 때마다 새로운 ID 생성
     * Track ID가 수천 단위까지 증가
     * 선택한 객체가 잠깐 사라지면 표시도 사라짐
   - 개선 내용
     1) Greedy IoU Matching 정리
        ```text
        const float IOU_MATCH_THR = 0.25f;
        const int MAX_MISSING = 20;
        const int CLEAR_MISSING = 8;
        ```
       * confidence 기준 정렬 후 매칭
       * track 1:1 매칭 보장
       * 미매칭 track은 missing++
       * 일정 프레임 이상 미검출 시 제거
     2) 선택 객체 유지 로직 추가
       * 선택 객체가 한 프레임 검출 실패해도
         tracks에 남아있는 마지막 box 기준으로 표시
         ```text
         bool selected_drawn = false;
         for (const auto& p : dets_with_id) {
             if (p.first == cur_selected) {
                 selected_drawn = true;
                 break;
             }
         }

         if (cur_selected != -1 && !selected_drawn) {
             // tracks에서 마지막 위치 표시 (노란색)
         }
         ```

2. JSON 구조 분리(tracks_all/tracks_visible)
   - 문제
     * 선택 시 전체 목록이 사라짐
     * UI에서 목록과 실제 표시 객체 구분 불가
   - 개선
     * tracks_all
     * 누적 트랙 목록
       ```text
       "tracks_all": [...]
       ```
     * tracks_visible, 현재 프레임에서 실제 검출된 객체
       ```text
       "tracks_visible": [...]
       ```
     * UI에서 Track 패널과 Detections 패널 완전 분리

3. UI 구조 개선
   - 구조 변경
     * 좌측 패널
       * Settings
       * Tracks(누적)
     * 영상 아래
       * Detections(현재 프레임)
       * FPS Badge
       * 선택 상태 배너
   - 선택 기능
     * 트랙 클릭 -> 선택
     * 재클릭 -> 해제
     * 선택 시:
       * 다른 객체 숨김
       * 선택 객체 강조 표시
       * 화면 이탈 시 자동 해제
<img width="882" height="965" alt="스크린샷 2026-02-12 19 23 03" src="https://github.com/user-attachments/assets/e6f8deda-57eb-4923-8424-79405d1edcb0" />

      
4. FPS 실시간 표시
   - C++측 계산
     ```text
     fps_infer
     fps_stream
     ```
   - status API 확장
     ```text
     "fps_infer":12.34,
     "fps_stream":11.98
     ```
   - JS 표시
     ```text
     fps(infer=xx, stream=xx)
     ```

5. MJPEG 스트림 안정화
   - condition_variable 기반 프레임 대기
   - stream_skip 적용
   - JPEG Quality 동적 변경 지원
  
6. 자동 실행 구성 및 디버깅
   - 부팅 시 자동 실행 설정 됨
     * systemd 아닌 다른 경로 가능성 확인
     * 현재 실행 중 프로세스 강제 종료 방법 정리
       ```text
       sudo pkill -TERM app_server
       sudo ss -lptn | grep :8080
       ```

< 오늘 해결한 핵심 문제 >
- Track ID 폭증 -> IoU threshold/missing 관리
- 선택 객체 표시 안 됨 -> last box fallback
- UI 반영 안 됨 -> tracks_all/visible 분리
- FPS 확인 불가 -> 실시간 계산 추가
- 스트림 버벅임 -> skip + cv 기반 개선

< 현재 상태 >
- Web UI 정상 동작
- 선택 객체 유지 안정화
- 실시간 FPS 표시
- Track 목록 정상 반영
- RKNN 모델 변환 정상(Hybrid INT8 Large 제외)
