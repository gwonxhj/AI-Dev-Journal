# Odroid M2 기반 RKNN 실시간 객체 탐지 웹 모니터링 시스템

1. 시스템 개요
   - 본 프로젝트는 Odroid M2(RK3588) 보드에서 YOLOv8 RKNN 모델(FP16/Hybrid INT8)을 이용하여
     비디오 파일 기반 실시간 객체 탐지(Person)을 수행하고, 웹 브라우저를 통해 실시간 영상 스트리밍 및
     설정 제어가 가능한 모니터링 시스템을 구현한 것이다.
     카메라 입력 대신 사전 녹화된 영상(mp4)을 입력으로 사용하며, 추후 실시간 카메라/RTSP로 확장 가능한
     구조로 설계되었다.

2. 전체 파이프라인 개요
[ Video File (.mp4) ]
        ↓
[ OpenCV VideoCapture ]
        ↓
[ Decode Thread (Frame Producer) ]
        ↓
[ Latest Frame Buffer (Queue = 1) ]
        ↓
[ Inference Thread ]
    ├─ Letterbox Resize (640 × 640)
    ├─ RGB / BGR Color Conversion
    ├─ RKNN Inference (NPU)
    ├─ Post-processing (Decode + NMS)
    ├─ Bounding Box + Confidence Overlay
        ↓
[ JPEG Encode (OpenCV) ]
        ↓
[ MJPEG Stream Buffer ]
        ↓
[ HTTP Server (cpp-httplib) ]
        ↓
[ Web Browser (Safari / Chrome) ]

4. 핵심 기술 스택
   - 하드웨어
     * Odroid M2(RK3588)
       * NPU(3-Core)
       * ARM64 Linux
     * 개발 PC(MacBook) -> SSH 접속
   - 소프트웨어
     * C++ 17
     * RKNN Toolkit(rknn_api)
     * OpenCV(Video I/O, Image Processing)
     * cpp-httplib
     * MJPEG Streaming(multipart/x-mixed-replace)
     * HTML/CSS/JavaScript(Vanilla)

5. 멀티스레드 처리 구조
   4.1 Decode Thread(Producer)
       - VideoCapture로 mp4 파일 디코딩
       - 프레임을 latest_frame 하나만 유지
       - EOF 시 자동 rewind
       - 과도한 CPU 점유 방지용 sleep 삽입
         decode thread
          → read frame
          → overwrite latest_frame
       - 특징
         * 프레임 큐 미사용 -> 지연 누적 방지
         * 실시간성 우선 구조
   4.2 Inference Thread(Consumer)
       - 최신 프레임만 가져와 추론
       - RKNN 모델 동적 로딩 지원
       - FP16/Hybrid INT8 공통 인터페이스
       - 결과 Overlay + JPEG 인코딩
         latest_frame
          → letterbox
          → rknn_run
          → postprocess
          → draw bbox + confidence
          → jpeg encode
       - 특징
         * 모델 교체 시 inference thread만 reload
         * 입력 모델 구조 차이(single/split output) 자동 대응
         * Queue=1 구조로 프레임 밀림 없음

6. RKNN 모델 처리 구조
   - 지원 모델
     * YOLOv8 n/s/m/l
     * Backend
       * FP16
       * Hybrid INT8(Preset B)
   - 공통 인터페이스
     * 입력: uint8 NHWC 640x640
     * 출력
       * single output[1, C, N]
       * or split output(output0_boxes, output0_scores)
   - Post-processing
     * Bounding box decode
     * Sigmoid 보정(로그잇 방어)
     * NMS(class-aware)
     * 원본 해상도로 좌표 복원
    
7. HTTP 웹 서버 구조
   - 서버
     * cpp-httplib
     * 0.0.0.0:8080 바인딩
   - 제공 엔드포인트
     * 정적 페이지
       * / -> UI
       * /app.js
       * /style.css
     * API
       * /api/status
         * 현재 설정
         * inference time
         * detection count
       * /api/videos
         * videos/ 폴더 내 mp4 목록
       * /api/set
         * backend(fp16/int8)
         * model size(n/s/m/l)
         * rgb on/off
         * conf/nms
         * video 선택
         * jpeg quality
     - 스트리밍
       * /stream.mjpg
         * MJPEG(multipart)
         * 약 25fps 제한

8. 웹 UI 기능
   - 실시간 영상 스트리밍
   - Person BBox + Confidence 표시
   - 실시간 설정 변경
     * 모델 크기
     * FP16/INT8
     * Confidence/NMS
     * 영상 파일 선택
   - 페이지 새로고침 없이 즉시 반영
   - Safari/Chrome 테스트 완료

9. 성능 및 안정성 설계 포인트
   - Queue 없는 최신 프레임 방식 -> 지연 없음
   - inference/decode 분리 -> CPU/NPU 효율적 사용
   - MJPEG fps 제한 -> 브라우저 안정성 확보
   - RKNN 출력 prealloc -> 메모리 안정화
   - 모델 로딩 실패 시 자동 재시도
  
10. 현재 상태 요약
   - RKNN 기반 실시간 추론 파이프라인 완성
   - 웹 서버 + MJPEG 스트리밍 연동
   - 모델/백엔드/영상 실시간 변경
   - Odroid 외부 브라우저 접속 성공
   - FP16/Hybrid INT8 공통 추론 구조 확립
   - Large Hybrid INT8 정밀도 튜닝 진행 중
  
11. 향후 확장 계획
   - RTSP/USB Camera 입력
   - WebSocket 기반 control channel
   - 추론 FPS/NPU load 시각화
   - multi-class 지원
